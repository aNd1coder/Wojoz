var FCKDragTableHandler={_DragState:0,_LeftCell:null,_RightCell:null,_MouseMoveMode:0,_ResizeBar:null,_OriginalX:null,_MinimumX:null,_MaximumX:null,_LastX:null,_TableMap:null,_doc:document,_IsInsideNode:function(h,b,a){var c=FCKTools.GetWindowPosition(h,b),d=c.x,e=c.y,f=parseInt(d,10)+parseInt(b.offsetWidth,10),g=parseInt(e,10)+parseInt(b.offsetHeight,10);return a.x>=d&&a.x<=f&&a.y>=e&&a.y<=g?true:false},_GetBorderCells:function(q,j,k,h){for(var b=[],a=0;a<j.rows.length;a++)for(var p=j.rows[a],i=0;i<p.cells.length;i++)b.push(p.cells[i]);if(b.length<1)return null;for(var c=null,f=null,g=null,d=null,e=null,a=0;a<b.length;a++){var o=FCKTools.GetWindowPosition(q,b[a]),t=o.x+parseInt(b[a].clientWidth,10),m=h.x-t,n=h.y-(o.y+b[a].clientHeight/2);if(c==null||Math.abs(m)<=Math.abs(c)&&(g==null||Math.abs(n)<=Math.abs(g))){c=m;g=n;d=b[a]}}var l=d.parentNode.rowIndex,s=FCKTableHandler._GetCellIndexSpan(k,l,d),r=isNaN(d.colSpan)?1:d.colSpan;e=k[l][s+r];if(!e)return null;f=h.x-FCKTools.GetWindowPosition(q,e).x;return f<0&&c<0&&c<-2?null:f>0&&c>0&&f>3?null:{leftCell:d,rightCell:e}},_GetResizeBarPosition:function(){var a=FCKTools.GetElementAscensor(this._RightCell,"tr");return FCKTableHandler._GetCellIndexSpan(this._TableMap,a.rowIndex,this._RightCell)},_ResizeBarMouseDownListener:function(d){if(FCKDragTableHandler._LeftCell)FCKDragTableHandler._MouseMoveMode=1;if(FCKBrowserInfo.IsIE)FCKDragTableHandler._ResizeBar.filters.item("DXImageTransform.Microsoft.Alpha").opacity=50;else FCKDragTableHandler._ResizeBar.style.opacity=.5;FCKDragTableHandler._OriginalX=d.clientX;for(var i=FCKDragTableHandler._GetResizeBarPosition(),l=FCKDragTableHandler._GetIframeOffset(),m=FCKTools.GetElementAscensor(FCKDragTableHandler._LeftCell,"table"),c=null,b=null,e=0;e<FCKDragTableHandler._TableMap.length;e++){var k=FCKDragTableHandler._TableMap[e][i-1],a=FCKDragTableHandler._TableMap[e][i],g=FCKTools.GetWindowPosition(FCK.EditorWindow,k),f=FCKTools.GetWindowPosition(FCK.EditorWindow,a),j=FCKDragTableHandler._GetCellPadding(m,k),h=FCKDragTableHandler._GetCellPadding(m,a);if(c==null||g.x+j>c)c=g.x+j;if(b==null||f.x+a.clientWidth-h<b)b=f.x+a.clientWidth-h}FCKDragTableHandler._MinimumX=c+l.x;FCKDragTableHandler._MaximumX=b+l.x;FCKDragTableHandler._LastX=null;if(d.preventDefault)d.preventDefault();else d.returnValue=false},_ResizeBarMouseUpListener:function(){FCKDragTableHandler._MouseMoveMode=0;FCKDragTableHandler._HideResizeBar();if(FCKDragTableHandler._LastX==null)return;for(var m=FCKDragTableHandler._LastX-FCKDragTableHandler._OriginalX,h=FCKTools.GetElementAscensor(FCKDragTableHandler._LeftCell,"table"),e=[],d=FCKDragTableHandler._TableMap,a=0;a<d.length;a++)for(var c=0;c<d[a].length;c++){var b=d[a][c],n=FCKDragTableHandler._GetCellWidth(h,b),f=isNaN(b.colSpan)?1:b.colSpan;if(e.length<=c)e.push({width:n/f,colSpan:f});else{var j=e[c];if(j.colSpan>f){j.width=n/f;j.colSpan=f}}}colIndex=FCKDragTableHandler._GetResizeBarPosition();colIndex--;e[colIndex].width+=m;e[colIndex+1].width-=m;for(var l=0;l<h.rows.length;l++)for(var o=h.rows.item(l),k=0;k<o.cells.length;k++){var b=o.cells.item(k);b.width="";b.style.width=""}for(var i=h.getElementsByTagName("col"),a=i.length-1;a>=0;a--)i[a].parentNode.removeChild(i[a]);for(var g=[],a=0;a<d.length;a++)for(var c=0;c<d[a].length;c++){var b=d[a][c];if(b._Processed)continue;if(d[a][c-1]!=b)b.width=e[c].width;else b.width=parseInt(b.width,10)+parseInt(e[c].width,10);if(d[a][c+1]!=b){g.push(b);b._Processed=true}}for(var a=0;a<g.length;a++)if(FCKBrowserInfo.IsIE)g[a].removeAttribute("_Processed");else delete g[a]._Processed;FCKDragTableHandler._LastX=null},_ResizeBarMouseMoveListener:function(a){return FCKDragTableHandler._MouseMoveMode==0?FCKDragTableHandler._MouseFindHandler(FCK,a):FCKDragTableHandler._MouseDragHandler(FCK,a)},_GetCellPadding:function(f,c){var d=parseInt(f.cellPadding,10)*2,a=null;if(typeof window.getComputedStyle=="function"){var e=window.getComputedStyle(c,null);a=parseInt(e.getPropertyValue("padding-left"),10)+parseInt(e.getPropertyValue("padding-right"),10)}else a=parseInt(c.currentStyle.paddingLeft,10)+parseInt(c.currentStyle.paddingRight,10);var b=c.style.padding;if(isFinite(b))a=parseInt(b,10)*2;else{b=c.style.paddingLeft;if(isFinite(b))a=parseInt(b,10);b=c.style.paddingRight;if(isFinite(b))a+=parseInt(b,10)}d=parseInt(d,10);a=parseInt(a,10);if(isNaN(d))d=0;if(isNaN(a))a=0;return Math.max(d,a)},_GetCellWidth:function(c,b){var a=b.clientWidth;if(isNaN(a))a=0;return a-this._GetCellPadding(c,b)},MouseMoveListener:function(b,a){return FCKDragTableHandler._MouseMoveMode==0?FCKDragTableHandler._MouseFindHandler(b,a):FCKDragTableHandler._MouseDragHandler(b,a)},_MouseFindHandler:function(c,f){if(c.MouseDownFlag)return;var a=f.srcElement||f.target;try{if(!a||a.nodeType!=1){this._HideResizeBar();return}}catch(o){this._HideResizeBar();return}var b=f.clientX,e=f.clientY;if(FCKTools.GetElementDocument(a)==document){var l=this._GetIframeOffset();b-=l.x;e-=l.y}if(this._ResizeBar&&this._LeftCell){var n=FCKTools.GetWindowPosition(c.EditorWindow,this._LeftCell),m=FCKTools.GetWindowPosition(c.EditorWindow,this._RightCell),j=b-(n.x+this._LeftCell.clientWidth),i=b-m.x,d=false;if(i>=0&&j<=0)d=true;else if(j>0&&i<=3)d=true;else if(i<0&&j>=-2)d=true;if(d){this._ShowResizeBar(c.EditorWindow,FCKTools.GetElementAscensor(this._LeftCell,"table"),{x:b,y:e});return}}var h=a.tagName.toLowerCase();if(h!="table"&&h!="td"&&h!="th"){if(this._LeftCell)this._LeftCell=this._RightCell=this._TableMap=null;this._HideResizeBar();return}a=FCKTools.GetElementAscensor(a,"table");var k=FCKTableHandler._CreateTableMap(a),g=this._GetBorderCells(c.EditorWindow,a,k,{x:b,y:e});if(g==null){if(this._LeftCell)this._LeftCell=this._RightCell=this._TableMap=null;this._HideResizeBar()}else{this._LeftCell=g.leftCell;this._RightCell=g.rightCell;this._TableMap=k;this._ShowResizeBar(c.EditorWindow,FCKTools.GetElementAscensor(this._LeftCell,"table"),{x:b,y:e})}},_MouseDragHandler:function(f,b){var a={x:b.clientX,y:b.clientY},e=b.srcElement||b.target;if(FCKTools.GetElementDocument(e)==f.EditorDocument){var c=this._GetIframeOffset();a.x+=c.x;a.y+=c.y}if(a.x>=this._MaximumX-5)a.x=this._MaximumX-5;if(a.x<=this._MinimumX+5)a.x=this._MinimumX+5;var d=a.x+FCKTools.GetScrollPosition(window).X;this._ResizeBar.style.left=d-this._ResizeBar.offsetWidth/2+"px";this._LastX=a.x},_ShowResizeBar:function(n,h,o){if(this._ResizeBar==null){this._ResizeBar=this._doc.createElement("div");var a=this._ResizeBar,d={position:"absolute",cursor:"e-resize"};if(FCKBrowserInfo.IsIE)d.filter="progid:DXImageTransform.Microsoft.Alpha(opacity=10,enabled=true)";else d.opacity=.1;FCKDomTools.SetElementStyles(a,d);this._avoidStyles(a);a.setAttribute("_fcktemp",true);this._doc.body.appendChild(a);FCKTools.AddEventListener(a,"mousemove",this._ResizeBarMouseMoveListener);FCKTools.AddEventListener(a,"mousedown",this._ResizeBarMouseDownListener);FCKTools.AddEventListener(document,"mouseup",this._ResizeBarMouseUpListener);FCKTools.AddEventListener(FCK.EditorDocument,"mouseup",this._ResizeBarMouseUpListener);var b=this._doc.createElement("img");b.setAttribute("_fcktemp",true);b.border=0;b.src=FCKConfig.BasePath+"images/spacer.gif";b.style.position="absolute";a.appendChild(b);var k=function(a){if(a.preventDefault)a.preventDefault();else a.returnValue=false};FCKTools.AddEventListener(b,"dragstart",k);FCKTools.AddEventListener(b,"selectstart",k)}var a=this._ResizeBar,m=this._GetIframeOffset(),g=this._GetTablePosition(n,h),e=h.offsetHeight,l=m.y+g.y;if(g.y<0){e+=g.y;l-=g.y}var i=parseInt(h.border,10);if(isNaN(i))i=0;var j=parseInt(h.cellSpacing,10);if(isNaN(j))j=0;var f=Math.max(i+100,j+100),d={top:l+"px",height:e+"px",width:f+"px",left:m.x+o.x+FCKTools.GetScrollPosition(n).X-f/2+"px"};if(FCKBrowserInfo.IsIE)a.filters.item("DXImageTransform.Microsoft.Alpha").opacity=10;else d.opacity=.1;FCKDomTools.SetElementStyles(a,d);var b=a.getElementsByTagName("img")[0];FCKDomTools.SetElementStyles(b,{width:a.offsetWidth+"px",height:e+"px"});f=Math.max(i,j,3);var c=null;if(a.getElementsByTagName("div").length<1){c=this._doc.createElement("div");this._avoidStyles(c);c.setAttribute("_fcktemp",true);a.appendChild(c)}else c=a.getElementsByTagName("div")[0];FCKDomTools.SetElementStyles(c,{position:"absolute",backgroundColor:"blue",width:f+"px",height:e+"px",left:"50px",top:"0px"})},_HideResizeBar:function(){this._ResizeBar&&FCKDomTools.SetElementStyles(this._ResizeBar,{top:"-100000px",left:"-100000px"})},_GetIframeOffset:function(){return FCKTools.GetDocumentPosition(window,FCK.EditingArea.IFrame)},_GetTablePosition:function(b,a){return FCKTools.GetWindowPosition(b,a)},_avoidStyles:function(a){FCKDomTools.SetElementStyles(a,{padding:"0",backgroundImage:"none",border:"0"})},Reset:function(){FCKDragTableHandler._LeftCell=FCKDragTableHandler._RightCell=FCKDragTableHandler._TableMap=null}};FCK.Events.AttachEvent("OnMouseMove",FCKDragTableHandler.MouseMoveListener);FCK.Events.AttachEvent("OnAfterSetHTML",FCKDragTableHandler.Reset);