var dialog=window.parent,oEditor=dialog.InnerDialogLoaded(),FCK=oEditor.FCK,FCKLang=oEditor.FCKLang,FCKConfig=oEditor.FCKConfig,FCKDebug=oEditor.FCKDebug,FCKTools=oEditor.FCKTools,bImageButton=document.location.search.length>0&&document.location.search.substr(1)=="ImageButton";dialog.AddTab("Info","网络图片");dialog.AddTab("Upload","本地上传");function OnDialogTabChange(a){ShowE("divInfo",a=="Info");ShowE("divUpload",a=="Upload")}var oImage=dialog.Selection.GetSelectedElement();if(oImage&&oImage.tagName!="IMG"&&!(oImage.tagName=="INPUT"&&oImage.type=="image"))oImage=null;var oLink=dialog.Selection.GetSelection().MoveToAncestorNode("A"),oImageOriginal;function UpdateOriginal(a){if(!eImgPreview)return;if(GetE("txtUrl").value.length==0){oImageOriginal=null;return}oImageOriginal=document.createElement("IMG");if(a)oImageOriginal.onload=function(){this.onload=null;ResetSizes()};oImageOriginal.src=eImgPreview.src}var bPreviewInitialized;window.onload=function(){oEditor.FCKLanguageManager.TranslatePage(document);GetE("btnLockSizes").title=FCKLang.DlgImgLockRatio;GetE("btnResetSize").title=FCKLang.DlgBtnResetSize;LoadSelection();UpdateOriginal();GetE("frmUpload").action=FCKConfig.BasePath+"filemanager/image/upload.aspx?ImageUploadAssembly="+dialog.getUrlParameter("ImageUploadAssembly");dialog.SetAutoSize(true);dialog.SetOkButton(true);SelectField("txtUrl")};function LoadSelection(){if(!oImage)return;var d=oImage.getAttribute("_fcksavedurl");if(d==null)d=GetAttribute(oImage,"src","");GetE("txtUrl").value=d;GetE("txtBorder").value=GetAttribute(oImage,"border","");GetE("cmbAlign").value=GetAttribute(oImage,"align","");var b,a,e=/^\s*(\d+)px\s*$/i;if(oImage.style.width){var g=oImage.style.width.match(e);if(g){b=g[1];oImage.style.width="";SetAttribute(oImage,"width",b)}}if(oImage.style.height){var f=oImage.style.height.match(e);if(f){a=f[1];oImage.style.height="";SetAttribute(oImage,"height",a)}}GetE("txtWidth").value=b?b:GetAttribute(oImage,"width","");GetE("txtHeight").value=a?a:GetAttribute(oImage,"height","");if(oEditor.FCKBrowserInfo.IsIE)GetE("txtAttStyle").value=oImage.style.cssText;else GetE("txtAttStyle").value=oImage.getAttribute("style",2);if(oLink){var c=oLink.getAttribute("_fcksavedurl");if(c==null)c=oLink.getAttribute("href",2);GetE("txtLnkUrl").value=c}UpdatePreview()}function Ok(){if(GetE("txtUrl").value.length==0){dialog.SetSelectedTab("Info");GetE("txtUrl").focus();alert(FCKLang.DlgImgAlertUrl);return false}var a=oImage!=null;if(a&&bImageButton&&oImage.tagName=="IMG"){if(confirm("Do you want to transform the selected image on a image button?"))oImage=null}else if(a&&!bImageButton&&oImage.tagName=="INPUT")if(confirm("Do you want to transform the selected image button on a simple image?"))oImage=null;oEditor.FCKUndo.SaveUndoStep();if(!a)if(bImageButton){oImage=FCK.EditorDocument.createElement("input");oImage.type="image";oImage=FCK.InsertElement(oImage)}else oImage=FCK.InsertElement("img");UpdateImage(oImage);var b=GetE("txtLnkUrl").value.Trim();if(b.length==0)oLink&&FCK.ExecuteNamedCommand("Unlink");else{if(oLink)oLink.href=b;else{!a&&oEditor.FCKSelection.SelectNode(oImage);oLink=oEditor.FCK.CreateLink(b)[0];if(!a){oEditor.FCKSelection.SelectNode(oLink);oEditor.FCKSelection.Collapse(false)}}SetAttribute(oLink,"_fcksavedurl",b);SetAttribute(oLink,"target","_blank")}return true}function UpdateImage(a){a.src=GetE("txtUrl").value;SetAttribute(a,"_fcksavedurl",GetE("txtUrl").value);SetAttribute(a,"width",GetE("txtWidth").value);SetAttribute(a,"height",GetE("txtHeight").value);SetAttribute(a,"border",GetE("txtBorder").value);SetAttribute(a,"align",GetE("cmbAlign").value);if(oEditor.FCKBrowserInfo.IsIE)a.style.cssText=GetE("txtAttStyle").value;else SetAttribute(a,"style",GetE("txtAttStyle").value)}var eImgPreview,eImgPreviewLink;function SetPreviewElements(a,b){eImgPreview=a;eImgPreviewLink=b;UpdatePreview();UpdateOriginal();bPreviewInitialized=true}function UpdatePreview(){if(!eImgPreview||!eImgPreviewLink)return;if(GetE("txtUrl").value.length==0)eImgPreviewLink.style.display="none";else{UpdateImage(eImgPreview,true);if(GetE("txtLnkUrl").value.Trim().length>0)eImgPreviewLink.href="javascript:void(null);";else SetAttribute(eImgPreviewLink,"href","");eImgPreviewLink.style.display=""}}var bLockRatio=true;function SwitchLock(a){bLockRatio=!bLockRatio;a.className=bLockRatio?"BtnLocked":"BtnUnlocked";a.title=bLockRatio?"Lock sizes":"Unlock sizes";if(bLockRatio)if(GetE("txtWidth").value.length>0)OnSizeChanged("Width",GetE("txtWidth").value);else OnSizeChanged("Height",GetE("txtHeight").value)}function OnSizeChanged(b,a){if(oImageOriginal&&bLockRatio){var c=b=="Width"?GetE("txtHeight"):GetE("txtWidth");if(a.length==0||isNaN(a)){c.value="";return}if(b=="Width")a=a==0?0:Math.round(oImageOriginal.height*(a/oImageOriginal.width));else a=a==0?0:Math.round(oImageOriginal.width*(a/oImageOriginal.height));if(!isNaN(a))c.value=a}UpdatePreview()}function ResetSizes(){if(!oImageOriginal)return;if(oEditor.FCKBrowserInfo.IsGecko&&!oImageOriginal.complete){setTimeout(ResetSizes,50);return}GetE("txtWidth").value=oImageOriginal.width;GetE("txtHeight").value=oImageOriginal.height;UpdatePreview()}var sActualBrowser;function SetUrl(c,b,a){if(sActualBrowser=="Link"){GetE("txtLnkUrl").value=c;UpdatePreview()}else{GetE("txtUrl").value=c;GetE("txtWidth").value=b?b:"";GetE("txtHeight").value=a?a:"";UpdatePreview();UpdateOriginal(true)}dialog.SetSelectedTab("Info")}function OnUploadCompleted(b,c,a){window.parent.Throbber.Hide();GetE("divUpload").style.display="";a.length>0&&window.alert(a);if(!b)return;sActualBrowser="";SetUrl("http://www.pt9999.com"+c);GetE("frmUpload").reset()}function CheckUpload(){var a=GetE("txtUploadFile").value;if(a.length==0){alert("请选择您要上传的图片！");return false}window.parent.Throbber.Show(100);GetE("divUpload").style.display="none";return true};